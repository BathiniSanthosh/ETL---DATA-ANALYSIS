-- CREATING STAGING SCHEMA
CREATE SCHEMA STAGE
-- CREATE STAGE TABLE STRUCTURE

CREATE TABLE Stage.Movies ([UserId] int not null,[Title] varchar(200), [Year] int , Genre varchar(100),Rating float)

-- CREATE DIM AND FACT SCHEMA

CREATE SCHEMA DIM
CREATE SCHEMA FACT

-- CREATE DIMENSION AND FACT TABLE STRUCTURE

CREATE TABLE DIM.[TITLE] (TITLE_KEY INT  IDENTITY(1,1) , TITLE VARCHAR(200),  CONSTRAINT PK_TITLE PRIMARY KEY CLUSTERED (TITLE_KEY) )
CREATE TABLE DIM.[YEAR] (YEAR_KEY INT  IDENTITY(1,1) , [YEAR] INT, CONSTRAINT PK_YEAR PRIMARY KEY CLUSTERED (YEAR_KEY) )
CREATE TABLE DIM.[USER](USER_KEY INT IDENTITY(1,1), USERID INT,CONSTRAINT PK_USER PRIMARY KEY CLUSTERED (USER_KEY))
CREATE TABLE DIM.[GENRE](GENRE_KEY INT IDENTITY(1,1), GENRE VARCHAR(100),CONSTRAINT PK_GENRE PRIMARY KEY CLUSTERED (GENRE_KEY))
CREATE TABLE FACT.RATING(USER_KEY INT,TITLE_KEY INT,YEAR_KEY INT,GENRE_KEY INT,RATING FLOAT)

ALTER TABLE FACT.RATING
ADD CONSTRAINT FK_TITLE FOREIGN KEY  (TITLE_KEY) REFERENCES DIM.[TITLE](TITLE_KEY);

ALTER TABLE FACT.RATING
ADD CONSTRAINT FK_USER FOREIGN KEY  (USER_KEY) REFERENCES DIM.[USER](USER_KEY);

ALTER TABLE FACT.RATING
ADD CONSTRAINT FK_GENRE FOREIGN KEY (GENRE_KEY) REFERENCES DIM.[GENRE](GENRE_KEY);

ALTER TABLE FACT.RATING
ADD CONSTRAINT FK_YEAR FOREIGN KEY (YEAR_KEY) REFERENCES DIM.[YEAR](YEAR_KEY);


-- DIMENSION TABLE LOADS 

Create procedure dbo.Movie_Dimensions as

begin
INSERT INTO DIM.[TITLE] (TITLE) 

SELECT DISTINCT stg.TITLE FROM Stage.Movies stg left join 
DIM.title dt on stg.Title=dt.title where dt.title is null

Insert iNTO DIM.[YEAR] (YEAR) 

SELECT DISTINCT stg.YEAR FROM Stage.Movies stg
left join  DIM.year dt on stg.year=dt.year where dt.year is null


INSERT INTO DIM.[GENRE](GENRE)
SELECT DISTINCT
stg.GENRE FROM Stage.Movies stg

left join  DIM.genre dg on stg.genre=dg.genre where dg.genre is null


INSERT INTO DIM.[USER](USERID) 
SELECT DISTINCT
stg.UserId FROM Stage.Movies stg

left join  DIM.[user] du on stg.userid=du.userid where du.userid is null

end


-- FACT TABLE LOAD 
CREATE PROCEDURE DBO.Movie_fact AS
BEGIN

INSERT INTO FACT.RATING(USER_KEY ,TITLE_KEY ,YEAR_KEY ,GENRE_KEY ,RATING)
SELECT US.USER_KEY, TT.TITLE_KEY,YR.YEAR_KEY,GEN.GENRE_KEY,STG.RatinG 

FROM STAGE.MOVIES STG LEFT JOIN DIM.TITLE TT ON STG.Title=TT.TITLE 
LEFT JOIN  DIM.[USER] US ON US.USERID=STG.UserId
LEFT JOIN  DIM.[YEAR] YR ON YR.[YEAR]=STG.[Year]
LEFT JOIN DIM.GENRE GEN ON STG.Genre=GEN.GENRE
END


-- DATA VALIDATION SAMPLE RECORDS

SELECT TOP 20 * FROM STAGE.MOVIES
SELECT TOP 5 * FROM DIM.[TITLE]
SELECT TOP 5 * FROM DIM.[YEAR] 
SELECT TOP 5 * FROM DIM.[GENRE]
SELECT TOP 5 * FROM DIM.[USER]
SELECT TOP 5 * FROM FACT.RATING




